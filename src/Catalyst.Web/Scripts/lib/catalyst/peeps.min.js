var Peeps=function(){function e(){$(document).ready(function(){Peeps.Search.init(),Peeps.Forms.init(),Peeps.Dashboards.init(),Peeps.Editors.init()})}function n(){return!1}function t(e,n){try{var t=_.find(p,function(n){return n.event===e});if(void 0!==t&&null!==t)void 0!==n&&"function"==typeof n&&t.callbacks.push(n);else{var i=[];void 0!==n&&"function"==typeof n&&i.push(n),p.push({event:e,callbacks:i})}}catch(e){console.info(e)}}function i(e,n){var t=_.find(p,function(n){return n.event===e});void 0!==t&&null!==t&&_.each(t.callbacks,function(t){try{t(e,n)}catch(e){console.info(e)}})}function o(e){var n={};return function(t,i){return n[t]||(n[t]=$.Deferred(function(n){e(n,t)}).promise()),n[t].done(i)}}function r(e,n){var t=_.find(e,function(e){return e.alias===n});return void 0===t?"":t.name}function s(e){l.events&&_.each(e,function(e){MUI.on(e.name,function(n,t){console.log(e),console.log(void 0===t?"No args":t)})})}function a(e){l.console&&console.log(e)}function d(e){return $(e).length>0}var l={events:!1,console:!1},p=[];return{Settings:{},Editors:{},init:e,willWork:d,hasLogger:n,createCache:o,on:t,emit:i,getEventNameByAlias:r,debugConsoleEvents:s,debugConsole:a}}();Peeps.Settings={localCacheDuration:10,spinnerSvg:"/Media/Placeholders/balls.svg",enableApiDelays:!0,searchApiEndpoint:"/api/searchapi/getall/",newPerson:"/people/newperson/",apiRoutes:[{id:"countrymetrics",value:"/dashboard/countriessnapshot",reqId:!1,title:"Querying Country Metrics...",notes:"Country filter queries not implemented.",delay:750},{id:"peopleprops",value:"/dashboard/peoplepropertystats",reqId:!1,title:"Evaluating Profiles...",notes:"Property filter queries not implemented.",delay:1250},{id:"randomwatched",value:"/dashboard/randomwatched",reqId:!1,title:"Selecting random...",notes:"Randomly selected from watched",delay:0},{id:"addperson",value:"/editors/personeditor/editor",reqId:!1,title:"Loading form...",notes:"",delay:0},{id:"updateperson",value:"/editors/personeditor/editor",reqId:!0,title:"Loading form...",notes:"",delay:0},{id:"interestlist",value:"/editors/interesteditor/editor",reqId:!0,title:"Loading form...",notes:"",delay:0},{id:"sociallinks",value:"/editors/sociallinkseditor/editor",reqId:!0,title:"Loading form...",notes:"",delay:0},{id:"photo",value:"/editors/photoeditor/editor",reqId:!0,title:"Loading form...",notes:"",delay:0},{id:"address",value:"/editors/addresseditor/editor",reqId:!0,title:"Loading form...",notes:"",delay:0}]},Peeps.Dialogs={confirmDelete:function(e,n,t){t=void 0===t?"person":t,Peeps.Dialogs.confirm({title:"Delete this "+t+"?",message:"This <strong>"+t+"</strong> will be permanently deleted and cannot be recovered. Are you sure?",confirm:e,cancel:n})},confirm:function(e){var n=$('<div id="dialog-confirm" title="'+e.title+'"><p><span class="ui-icon ui-icon-alert" style="float:left; margin:12px 12px 20px 0;"></span>'+e.message+"</p></div>");$("#peeps").html(n),$("#dialog-confirm").dialog({resizable:!1,height:"auto",width:400,modal:!0,buttons:{Confirm:function(){void 0!==e.confirm&&e.confirm(),$(this).dialog("close")},Cancel:function(){void 0!==e.cancel&&e.cancel(),$(this).dialog("close")}}})},popForm:function(e){var n='<div id="dialog-form" title="Create new user">'+e.frm+"</div>";return $("#peeps").html(n),$("#dialog-form").dialog({autoOpen:!1,height:"auto",width:600,modal:!0})}},Peeps.Dashboards={loadedEvtName:"dashboardLoaded",init:function(){var e=$("div[data-dashboard]");e.length&&_.each(e,function(e){Peeps.Dashboards.binder.invoke(e)})},binder:{invoke:function(e){var n=$(e).data("dashboard"),t=Peeps.Dashboards.spinner.makeId();Peeps.Dashboards.spinner.appendSpinner(e,t);var i={dashboard:e,args:{},skip:!0};if("donothing"!==n){var o=_.find(Peeps.Settings.apiRoutes,function(e){if(e.id===n)return e});void 0!==o&&(i.args=o,i.skip=!1,Peeps.Dashboards.binder.query(i))}},query:function(e){if(void 0===e)throw new Error("Routing params have not been defined.");var n=e.dashboard;$(n).find(".chart-title").text(e.args.title);var t=void 0===e.args.delay?0:e.args.delay;Peeps.Settings.enableApiDelays||(t=0),t>0&&$(n).find(".chart-notes").text("FAKE DELAY of ("+e.args.delay+" ms) added for demo!"),$(n).find(""),$.ajax({url:e.args.value,dataType:"html"}).done(function(i){setTimeout(function(){$(n).parent().html(i),$(n).find(".chart-notes").text("Note:"),Peeps.emit(Peeps.Dashboards.loadedEvtName,{panel:n,params:e.args})},t)}).fail(function(e,n,t){console.info({jqXHR:e,status:n,error:t})}).always(function(){Peeps.debugConsole({msg:"Finished dashboard $.ajax",params:e})})}},spinner:{activeIds:[],appendSpinner:function(e,n){void 0===e&&(e=Peeps.Editors.Person.editorPanel.find(".chart-wrapper")),Peeps.Dashboards.spinner.activeIds.push(n);var t=Peeps.Dashboards.spinner.build(n);$(e).find(".chart-stage").html(t)},build:function(e){return $('<div class="dashboard-spinner"><img src="'+Peeps.Settings.spinnerSvg+'" id="'+e+'" alt="Loading..." /></div>')},makeId:function(){for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;t<10;t++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}}},Peeps.Search={peopleMap:{},names:[],current:{},init:function(){Peeps.willWork("#person-search")&&$.get(Peeps.Settings.searchApiEndpoint).done(function(e){_.each(e,function(e){Peeps.Search.peopleMap[e.name]=e,Peeps.Search.names.push(e.name)}),Peeps.Search.bind.searchBox($("#person-search"))})},bind:{searchBox:function(e){var n=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,local:Peeps.Search.names});$(e).bind("keydown",function(e){var n=new RegExp("^[a-zA-Z0-9]"),t=e.charCode?e.charCode:e.which,i=String.fromCharCode(t);if(!n.test(i)&&32!==t&&8!==t)return e.preventDefault(),!1}).typeahead({hint:!0,highlight:!0,minLength:1},{name:"names",source:n}).bind("typeahead:select",function(e,n){console.log("Selection: "+n),Peeps.Search.redirect(n)}).bind("typeahead:autocompleted",function(e,n){console.log("Auto: "+n),Peeps.Search.redirect(n)})}},redirect:function(e){var n=Peeps.Search.peopleMap[e];window.location=n.url}},Peeps.Forms={fileSelectEvtName:"fileselect",init:function(){Peeps.Forms.bind.inputTypeFile()},rebind:function(e){$.validator.unobtrusive.parse(e)},bind:{inputTypeFile:function(){$(document).on("change",":file",function(){var e=$(this),n=e.get(0).files?e.get(0).files.length:1,t=e.val().replace(/\\/g,"/").replace(/.*\//,"");e.trigger("fileselect",[n,t,e.attr("id")]),Peeps.emit(Peeps.Forms.fileSelectEvtName,{id:e.attr("id"),fileName:t})}),$(":file").on("fileselect",function(e,n,t,i){Peeps.debugConsole(n),Peeps.debugConsole(t),Peeps.debugConsole(i)})}}},Peeps.Editors={init:function(){Peeps.Editors.Person.init()}},Peeps.Editors.Interests={route:{},saveEndpoint:"/editors/interesteditor/save/",init:function(){Peeps.Editors.Interests.route=_.find(Peeps.Settings.apiRoutes,function(e){if("interestlist"===e.id)return e}),Peeps.Editors.Interests.bind.form(),Peeps.Editors.Interests.bind.deletes()},bind:{form:function(){var e=$("#interests-editor"),n=Peeps.Editors.Interests.route;$(e).bind("submit",function(t){t.preventDefault(),Peeps.Dashboards.spinner.appendSpinner(),$.ajax({url:Peeps.Editors.Interests.saveEndpoint,type:"POST",data:$(e).serialize()}).done(function(e){Peeps.Editors.Person.bind.editorPanel(n,e)})})},deletes:function(){function e(e){$.get(e).done(function(e){Peeps.Editors.Person.bind.editorPanel(n,e)})}var n=Peeps.Editors.Interests.route;_.each($(".interest-trash"),function(n){$(n).bind("click",function(n){n.preventDefault();var t=$(this).attr("href");Peeps.Dialogs.confirmDelete(function(){Peeps.Dashboards.spinner.appendSpinner(),e(t)},void 0,"interest")})})}}},Peeps.Editors.Person={personId:"",editorPanel:null,init:function(){if(Peeps.on(Peeps.Dashboards.loadedEvtName,Peeps.Editors.Person.onDashboardLoaded),Peeps.on(Peeps.Forms.fileSelectEvtName,function(e,n){"fileselect"===e&&$(".photo-label-box").val(n.fileName)}),Peeps.Editors.Person.bind.deletes(),Peeps.willWork("#person-details")){var e=$("#person-details");Peeps.Editors.Person.personId=$(e).data("person")}Peeps.willWork("#editor-panel")&&(Peeps.Editors.Person.editorPanel=$("#editor-panel")),Peeps.Editors.Person.bind.editorLinks()},onDashboardLoaded:function(e,n){switch(n.params.id){case"addperson":case"updateperson":Peeps.Editors.Person.bind.personEntry(n);break;case"interestlist":Peeps.Editors.Interests.init()}},bind:{deletes:function(){Peeps.willWork(".delete-person")&&_.each($(".delete-person"),function(e){$(e).bind("click",function(e){e.preventDefault();var n=$(this).attr("href");Peeps.Dialogs.confirmDelete(function(){window.location=n})})})},editorPanel:function(e,n){Peeps.Editors.Person.editorPanel.html(n),$(Peeps.Editors.Person.editorPanel).find(".btn-cancel").bind("click",function(e){e.preventDefault(),window.location.reload()});var t=$(Peeps.Editors.Person.editorPanel).find("form");Peeps.Forms.rebind(t);var i=$(Peeps.Editors.Person.editorPanel).find(".chart-wrapper");Peeps.emit(Peeps.Dashboards.loadedEvtName,{panel:i,params:e})},editorLinks:function(){Peeps.willWork($("[data-editor]"))&&_.each($("[data-editor]"),function(e){var n=$(e).data("editor");$(e).bind("click",function(e){e.preventDefault();Peeps.Editors.Person.editorPanel.find(".chart-wrapper");Peeps.Dashboards.spinner.appendSpinner();var t=_.find(Peeps.Settings.apiRoutes,function(e){if(e.id===n)return e});$.ajax({url:t.value,dataType:"html",data:{id:Peeps.Editors.Person.personId}}).done(function(e){Peeps.Editors.Person.bind.editorPanel(t,e)})})})},personEntry:function(e){if(Peeps.willWork("#person-entry")){var n=$("#person-entry");Peeps.Forms.rebind(n),Peeps.Editors.Person.bind.birthday(n)}},birthday:function(e){$(e).find("#Birthday").datepicker({changeYear:!0,yearRange:"1930:2017"})}}},Peeps.init();